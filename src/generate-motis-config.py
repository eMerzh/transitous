#!/usr/bin/env python3
# SPDX-FileCopyrightText: 2024 Jonah Br√ºchert <jbb@kaidan.im>
#
# SPDX-License-Identifier: AGPL-3.0-or-later

import subprocess
import json
from ruamel.yaml import YAML
import metadata
import tomllib
import sys
import transitland

from pathlib import Path
from utils import eprint


if __name__ == "__main__":
    if len(sys.argv) < 2:
        print("First argument must be one of import, full")
        sys.exit(1)

    flavour = sys.argv[1]

    feed_dir = Path("feeds/")
    osm_map = "planet-latest.osm.pbf"
    osm_coastline = "land-polygons-complete-4326.zip"

    atlas = transitland.Atlas.load(Path("transitland-atlas/"))

    gtfs_feeds: list[dict] = []
    gtfsrt_feeds = []

    with open("motis/config.yml") as f:
        yaml = YAML(typ="rt")

        config = yaml.load(f)
        config.yaml_set_comment_before_after_key(
            "server",
            before="This file is automatically generated by ./src/generate-motis-config.py from motis/config.yml",
        )

        config["timetable"].yaml_set_comment_before_after_key(
            "datasets", before="Modified by generate-motis-config.py"
        )
        config["timetable"]["datasets"] = {}

        config.yaml_set_comment_before_after_key(
            "street_routing", before="Modified by generate-motis-config.py"
        )
        match flavour:
            case "import":
                config["street_routing"] = False
                config["osr_footpath"] = False
                config["elevators"] = False
                config["geocoding"] = False
                config["reverse_geocoding"] = True
            case "full":
                config["street_routing"] = True
                config["osr_footpath"] = True
                config["elevators"] = True
                config["geocoding"] = True
                config["reverse_geocoding"] = True

        for feed in sorted(feed_dir.glob("*.json")):
            with open(feed, "r") as f:
                parsed = json.load(f)
                region = metadata.Region(parsed)

                metadata_filename = feed.name
                region_name = metadata_filename[: metadata_filename.rfind(".")]

                for source in region.sources:
                    schedule_name = f"{region_name}-{source.name}"

                    if source.skip:
                        continue

                    match source:
                        case metadata.TransitlandSource():
                            source = atlas.source_by_id(source)
                            if not source:
                                continue

                    match source.spec:
                        case "gtfs":
                            schedule_file = f"{region_name}_{source.name}.gtfs.zip"
                            name = f"{region_name}-{source.name}"
                            config["timetable"]["datasets"][name] = {"path": schedule_file}

                        case "gtfs-rt" if isinstance(source, metadata.UrlSource):
                            name = f"{region_name}-{source.name}"
                            if name not in config["timetable"]["datasets"]:
                                eprint(
                                    "Error: The name of a realtime (gtfs-rt) "
                                    + "feed needs to match the name of its "
                                    + "static base feed defined before the "
                                    + "realtime feed. Found nothing "
                                    + "belonging to",
                                    source.name,
                                )
                                sys.exit(1)

                            config["timetable"]["datasets"][name]["rt"] = {
                                "url": source.url,
                                "headers": source.headers,
                            }

        with open("out/config.yml", "w") as fo:
            yaml.dump(config, fo)
